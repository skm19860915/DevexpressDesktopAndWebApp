EzRez.BingApi={};EzRez.BingApi.Confidence={HIGH:3,MEDIUM:2,LOW:1,UNKNOWN:0};EzRez.BingApi.Point=function(a){this.type=a.type||"";this.coordinates=a.coordinates||[];};EzRez.BingApi.Address=function(a){this.addressLine=a.addressLine||"";this.adminDistrict=a.adminDistrict||"";this.adminDistrict2=a.adminDistrict2||"";this.countryRegion=a.countryRegion||"";this.formattedAddress=a.formattedAddress||"";this.locality=a.locality||"";this.postalCode=a.postalCode||"";};EzRez.BingApi.LocationResource=function(a){this.bbox=a.bbox||[];this.name=a.name||"";this.confidence=EzRez.BingApi.Confidence[(a.confidence||"unknown").toUpperCase()];this.entityType=a.entityType||"";this.point=new EzRez.BingApi.Point(a.point);this.address=new EzRez.BingApi.Address(a.address);};EzRez.BingApi.ResourceSet=function(a){this.estimatedTotal=a.estimatedTotal||0;this.resources=a.resources||[];};EzRez.BingApi.LocationResourceSet=function(a){EzRez.BingApi.ResourceSet.apply(this,arguments);this.resources=this.resources;};EzRez.BingApi.Response=function(a){this.statusCode=a.statusCode||"";this.statusDescription=a.statusDescription||"";this.authenticationResultCode=a.authenticationResultCode||"";this.copyright=a.copyright||"";this.brandLogoUri=a.brandLogoUri||"";this.errorDetails=a.errorDetails||[];this.resourceSets=a.resourceSets||[];};EzRez.BingApi.LocationResponse=function(a){EzRez.BingApi.Response.apply(this,arguments);this.resourceSets=this.resourceSets;};EzRez.Connector={};EzRez.Connector.GeocoderType={BING:0,GOOGLE:1};EzRez.Connector.Geocoder=function(a){var c=Object.extend({apiKey:""},a);var d;var b;this.setViewPort=function(f,e){d=[f,e];};this.getViewPort=function(){return d;};this.setUserLocation=function(e){b=e;};this.getUserLocation=function(){return b;};this.getLocation=function(e,f){throw new EzRez.Util.Exception({message:"EzRez.Connector.Geocoder must implement getLocation()"});};this.getLocations=function(e,f){throw new EzRez.Util.Exception({message:"EzRez.Connector.Geocoder must implement getLocations()"});};this.getAddress=function(f,e,g){throw new EzRez.Util.Exception({message:"EzRez.Connector.Geocoder must implement getAddress()"});};};EzRez.Connector.GoogleGeocoder=function(b){var e=Object.extend({apiKey:""},b);EzRez.Connector.Geocoder.apply(this,arguments);var d={getViewPort:this.getViewPort,getUserLocation:this.getUserLocation};var a={200:"Success",400:"Bad Request",500:"Server Error",601:"Missing Query or Missing Address",602:"Unknown Address",603:"Unavailable Address",604:"Unknown Directions",610:"Bad Key",620:"Too Many Queries"};function h(i){EzRez.Util.Debug.info(i);console.info(i);}var g=new GClientGeocoder();function c(i){if(i instanceof EzRez.WebApi.Address){i="#{addressLine},#{city},#{state},#{zip},#{country}".interpolate({addressLine:i.addressLines.join(" "),city:i.city,state:i.stateCode,zip:i.zip,country:i.countryCode});}else{if(i instanceof EzRez.WebApi.GeoLocation){i=new GLatLng(i.lat,i.lng,false);}else{if(!Object.isString(i)){i="";}}}return i;}function f(k,m){var j=d.getViewPort();if(j){var i=new GLatLng(j[0].lat,j[0].lng,false);var l=new GLatLng(j[1].lat,j[1].lng,false);g.setViewPort(new GLatLngBounds(i,l));}k=c(k);g.getLocations(k,function(o){h("Geocoding address: "+k+".");var n=[];if(o.Status.code!=G_GEO_SUCCESS){h("  ClientGeocoder Request Error: "+o.Status.code+" - "+a[o.Status.code]+").");h("  Failed to geocode address.");m(n);return;}o.Placemark.each(function(p){n.push(new EzRez.WebApi.GeoLocation({lat:p.Point.coordinates[1],lng:p.Point.coordinates[0],formattedAddress:p.address}));});if(n.length===0){h("  No accurate locations");h("  Failed to geocode address ("+k+").");}m(n);});}this.getLocation=function(i,j){f(i,function(k){var l=k.length===0?null:k.first();j(l);});};this.getLocations=f;this.getAddress=function(k,j,l){var i=new EzRez.WebApi.GeoLocation({lat:k,lng:j});f(i,l);};};EzRez.Connector.BingGeocoder=function(d){var g=Object.extend({apiKey:""},d);var b=location.protocol+"//dev.virtualearth.net/REST/v1/Locations";EzRez.Connector.Geocoder.apply(this,arguments);var f={getViewPort:this.getViewPort,getUserLocation:this.getUserLocation};function h(i){EzRez.Util.Debug.info(i);}function a(){var m={key:g.apiKey};var k=f.getViewPort();if(k){var i=k[0];var l=k[1];m.mapView=[i.lat,i.lng,l.lat,l.lng].join(",");}var j=f.getUserLocation();if(j){m.userLocation=[j.lat,j.lng].join(",");}return m;}function c(i){var j=a();if(Object.isString(i)){j.q=i;}else{if(i instanceof EzRez.WebApi.Address){j=Object.extend({addressLine:i.addressLines.join(" "),locality:i.city,adminDistrict:i.stateCode,postalCode:i.zip,countryRegion:i.countryCode},j);}}return j;}function e(i,j,k){h("Bing geocode request started for "+Object.toJSON(j));new EzRez.Util.JsonpRequest(i,{jsonpCallbackQueryParam:"jsonp",parameters:j,timeout:5*1000,onFailure:function(l){new EzRez.Util.Exception({message:"Bing geocoding request failure for "+EzRez.StringUtil.toSplunkFriendlyString(j)});k([]);},onTimeout:function(l){new EzRez.Util.Debug.info({message:"Bing geocoding request timeout for "+EzRez.StringUtil.toSplunkFriendlyString(j)});k([]);},jsonpCallback:function(n){var m=new EzRez.BingApi.LocationResponse(n);var l=[];if(m.statusCode!="200"){h("Bing geocoding request failed. "+m.statusDescription);k(l);return;}if(m.resourceSets.length===0||m.resourceSets[0].resources.length===0){h("No geocode results for "+Object.toJSON(j));k(l);return;}m.resourceSets.each(function(o){o.resources.each(function(s){var r=new EzRez.BingApi.LocationResource(s);if(r.confidence<EzRez.BingApi.Confidence.MEDIUM){return;}var t=r.point.coordinates;var q=new EzRez.WebApi.GeoLocation();q.lat=t[0];q.lng=t[1];q.formattedAddress=r.address.formattedAddress;q.address=new EzRez.WebApi.Address({_addressLines:[r.address.addressLine],_city:r.address.locality,_stateCode:r.address.adminDistrict,_zip:r.address.postalCode,_countryCode:r.address.countryRegion});l.push(q);});});h("Geocode request complete for "+Object.toJSON(j));k(l);}});}this.getLocation=function(i,k){var j=c(i);if(EzRez.StringUtil.isEmpty(j.addressLine)){k(null);return;}e(b,j,function(l){if(!l||l.length===0){k(null);}else{k(l[0]);}});};this.getLocations=function(i,k){var j=c(i);e(b,j,k);};this.getAddress=function(k,j,m){var l=a();var i="#{url}/#{lat},#{lng}".interpolate({url:b,lat:k,lng:j});e(i,l,m);};};EzRez.Connector.GeocoderFactory=new function(){var b=EzRez.Connector.GeocoderType.BING;var a;this.getType=function(){return b;};this.setType=function(c){b=c;};this.setApiKey=function(c){a=c;};this.create=function(){switch(b){case EzRez.Connector.GeocoderType.BING:return new EzRez.Connector.BingGeocoder({apiKey:a});case EzRez.Connector.GeocoderType.GOOGLE:return new EzRez.Connector.GoogleGeocoder({apiKey:a});default:throw new EzRez.Util.Exception({message:"Connector type is not set in EzRez.Connector.GeocoderFactory"});}};};if(EzRez===undefined){throw ("ezrez-ui-gmap.js requires ezrez.js");}if(EzRez.Util===undefined){throw ("ezrez-ui-gmap.js requires ezrez-util.js");}if(EzRez.UI===undefined){throw ("ezrez-ui-gmap.js requires ezrez-ui.js");}EzRez.UI.StaticMap=function(b){this.cfg=Object.extend({width:400,height:400,center:new EzRez.WebApi.GeoLocation(),zoom:1,showCenter:true,apiKey:"",loc:location},b);var a=this;this.getSrcUrl=function(){return"/";};this.createImage=function(){return new Element("img",{src:a.getSrcUrl(),"class":"staticMapImage"});};this.getProto=function(){return a.cfg.loc.protocol+"//";};};EzRez.UI.BingStaticMap=function(b){EzRez.UI.StaticMap.apply(this,arguments);var c=this.cfg;var a=this.getProto()+"dev.virtualearth.net/REST/v1/Imagery/Map";this.getSrcUrl=function(){var d={ms:"#{width},#{height}".interpolate(c),key:c.apiKey};if(c.showCenter){d.pp="#{lat},#{lng};21".interpolate(c.center);}return"#{url}/#{imagerySet}/#{centerPoint}/#{zoomLevel}?#{params}".interpolate({url:a,imagerySet:"Road",centerPoint:"#{lat},#{lng}".interpolate(c.center),zoomLevel:c.zoom,params:Object.toQueryString(d)});};};EzRez.UI.GoogleStaticMap=function(b){EzRez.UI.StaticMap.apply(this,arguments);var c=this.cfg;var a=this.getProto()+"maps.googleapis.com/maps/api/staticmap";this.getSrcUrl=function(){var d={zoom:c.zoom,size:"#{width}x#{height}".interpolate(c),center:"#{lat},#{lng}".interpolate(c.center),sensor:false};if(c.showCenter){d.markers="#{lat},#{lng}".interpolate(c.center);}return a+"?"+Object.toQueryString(d);};};