if(EzRez===undefined){throw ("ezrez-ui-bingmap.js requires ezrez.js");}if(EzRez.Util===undefined){throw ("ezrez-ui-bingmap.js requires ezrez-util.js");}if(EzRez.UI===undefined){throw ("ezrez-ui-bingmap.js requires ezrez-ui.js");}(function(){var a=true;var d=true;function e(f){if(!d){return;}EzRez.Util.Debug.info(f,null);}function c(){try{return Microsoft.Maps.Map!==undefined||Microsoft.Maps.Map!==null;}catch(f){return false;}}if(!c()){a=false;e("Warning: Cannot run bing maps.");}function b(){if(!Microsoft.Maps.Pushpin.prototype.setDescription){Microsoft.Maps.Pushpin.prototype.setDescription=function(f){this.description=f;};}if(!Microsoft.Maps.Pushpin.prototype.getDescription){Microsoft.Maps.Pushpin.prototype.getDescription=function(){return this.description;};}}EzRez.UI.BingMap=function(o){var r=Object.extend({canvas_id:null,info_id:null,apiKey:"",width:null,height:null,default_zoom:2,geo_min_dec_figs:3,map_options:null,info_window_opts:null,hotelMapData:EzRez.UI.MapHotelData.getList(),setup:function(v){},geocodeComplete:function(){},default_center:{lat:20,lng:0}},o);var j;var h;var g=$H();var q=new EzRez.Connector.BingGeocoder({apiKey:r.apiKey});function m(){if(!Microsoft.Maps.MapTypeId){return;}var x=$(r.canvas_id);if(!x){throw new EzRez.Util.Exception({message:"Bing map canvas does not exist"});}var w={credentials:r.apiKey,enableClickableLogo:false,enableSearchLogo:false,disableKeyboardInput:true,mapTypeId:Microsoft.Maps.MapTypeId.road};var v=Microsoft.Maps.NavigationBarMode;if(v){w.navigationBarMode=v.compact;}return new Microsoft.Maps.Map(x,w);}function s(A,z){var x=A.getWidth();var v=A.getHeight();var y=$$(".info_window_ext_contents").first();if(y){x=y.getWidth();v=y.getHeight();}var B=j.tryLocationToPixel(z.getLocation(),Microsoft.Maps.PixelReference.viewport);var w=new Microsoft.Maps.Point(B.x+x,B.y-v);return j.tryPixelToLocation(w,Microsoft.Maps.PixelReference.viewport);}function u(){h=new Microsoft.Maps.Infobox(j.getCenter(),{showPointer:true,showCloseButton:true,visible:false,zIndex:1002});h.setMap(j);Microsoft.Maps.Events.addHandler(h,"click",function(x){var v=x.originalEvent;var w=Event.findElement(v,".bingInfoWindowCloseLink");if(w){h.setOptions({visible:false});}});}function l(A,v){var x=$("info_window_"+A.objectKey);if(!x){return null;}var y=new Element("a",{"class":"bingInfoWindowCloseLink"}).update("X");var w=x.clone(true).addClassName("info_window_ext_contents").writeAttribute("id","");w.insert({top:y});var z=new Element("div").update(w).innerHTML;h.setOptions({location:v,visible:true,htmlContent:z});}function i(v,w){if(!h){u();g.each(function(x){Microsoft.Maps.Events.addHandler(h,x.key,x.value);});}Microsoft.Maps.Events.addHandler(v,"click",function(y){var x=y.target.getLocation();l(w,x);j.setView({center:x});});Microsoft.Maps.Events.addHandler(v,"mouseover",function(){document.body.style.cursor="pointer";});Microsoft.Maps.Events.addHandler(v,"mouseout",function(){document.body.style.cursor="default";});return h;}function k(){if(h){h.setOptions({visible:false});}}var t=1;function f(x){if(!j){return;}if(!x){x=function(){};}if(7<t){t=0;console.warn("Bing Map failed to zoom...too many attempts.");x();return;}var v=[];for(var z=0;z<j.entities.getLength();z++){var y=j.entities.get(z);if(y instanceof Microsoft.Maps.Pushpin){v.push(y.getLocation());}else{if(y instanceof Microsoft.Maps.Polygon){y.getLocations().each(function(C){v.push(C);});}}}if(v.length===0){x();return;}var w={animate:false,padding:11};if(v.length===1){w.center=v.first();w.zoom=13;}else{var B=Microsoft.Maps.LocationRect.fromLocations(v);w.center=B.center;w.bounds=B;}j.setView(w);var A=j.getZoom();console.info("Bing Map zoomAll...");console.info("  zoom: "+A);console.info("  attempt: "+t);t++;if(A<=7){console.warn("Bing Map failed to zoom...trying again.");setTimeout(function(){f(x);},200);}else{t=0;x();}}function p(z){var B=[];var x=[];var v=[];function w(){console.dir({mappedHotels:x.length,unmappedHotels:v.length,hotels:z.length});if((x.length+v.length)!==z.length){console.info("bing init not complete");return;}console.info("bing init complete");Microsoft.Maps.Events.addHandler(j,"click",k);f(function(){r.geocodeComplete(x,v);});}function A(F){var H=F.hotel;var G=parseFloat(H.lat);var E=parseFloat(H.lng);if(E!==0&&G!==0){D(G,E,F);return true;}else{if(H.opaque){y(H.neighborhoods.first().polygonGeoLocations,F);return true;}}return false;}function D(I,G,F){var E=new Microsoft.Maps.Location(I,G);var H=new Microsoft.Maps.Pushpin(E,{text:F.label,icon:"/images/bing_map_marker.png"});H.hotelKey=F.hotel.objectKey;i(H,F.hotel);j.entities.push(H);B.push(E);x.push(F);}function y(G,F){var E=new Microsoft.Maps.Color(90,74,165,24);var H=C(G);var I=new Microsoft.Maps.Polygon(H,{fillColor:E,strokeColor:new Microsoft.Maps.Color(100,0,0,0),strokeThickness:1});j.entities.push(I);j.setView({bounds:Microsoft.Maps.LocationRect.fromLocations(H)});x.push(F);}function C(E){return E.map(function(F){return new Microsoft.Maps.Location(F.lat,F.lng);});}z.each(function(E){var F=E.hotel;if(!A(E)){q.getLocation(F.address,function(G){if(!G){v.push(E);}else{D(G.lat,G.lng,E);}w();});}});w();}function n(){var v=setInterval(function(){if(j){b();p(r.hotelMapData);clearInterval(v);}else{j=m();}},200);}this.addGeoCord=function(y,w,v){e("BingMap addGeoCord");if(isNaN(y)||isNaN(w)){e("bad coord for addGeoCord");return null;}var x=new Microsoft.Maps.Location(y,w);var z=new Microsoft.Maps.Pushpin(x,{text:v.label});if(j){j.entities.push(z);}return z;};this.addAddress=function(w,v,x){};this.parse=function(v){};this.zoomAll=f;this.center=function(v,w){var x=new Microsoft.Maps.Location(v.lat,v.lng);j.setView({center:x,zoom:w});};this.getMapCenter=function(){var v=j.getCenter();return new EzRez.WebApi.GeoLocation({lat:v.latitude,lng:v.longitude});};this.getMapZoom=function(){return j.getZoom();};this.clearMarkers=function(){j.entities.clear();};this.addListener=function(v,w){};this.addInfoBoxListener=function(v,w){g.set(v,w);};this.getMap=function(){return j;};this.getGeo=function(){return q;};this.getAddresses=function(){return[];};this.getMarkers=function(){var x=[];for(var w=0;w<j.entities.getLength();w++){var v=j.entities.get(w);x.push(v);}return x;};this.isCompatible=function(){return a;};this.fixCenter=function(w,v){if(!v){v=function(){};}if(w){f(v);}else{v();}};this.destroy=function(){try{j.dispose();}finally{var v=$(r.canvas_id);if(v){v.update("");}}};this.load=function(v){p(v);};n();};EzRez.UI.BingMap.isCompatible=function(){return c();};EzRez.UI.BingMap.unload=function(){};})();